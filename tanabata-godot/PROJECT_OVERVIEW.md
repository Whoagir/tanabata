# Tanabata (Godot) — краткое описание проекта

## О чём игра

**Tanabata** — 2D Tower Defense на гексагональной карте. Портируется с версии на Go. Игрок в фазе строительства ставит до 5 башен, в фазе выбора отмечает 2 башни для сохранения (остальные превращаются в стены), затем отражает волну врагов. Цикл повторяется: снова строительство, выбор, волна.

## Что есть в проекте

- **Карта:** гексы (pointy-top), процедурная генерация с входом, выходом и 6 чекпоинтами. Путь врагов: A* через чекпоинты.
- **Башни:** майнеры (дают энергию с руды), атакующие (стреляют по врагам, питаются от энергосети), стены (блокируют путь).
- **Энергосеть:** майнеры на руде — источники; атакующие работают только при соединении с сетью (MST, перехват майнер-майнер на линии).
- **Руда:** генерируется при старте (3 жилы), расходуется при выстрелах; ниже порога гекс не питает майнер.
- **Враги:** спавн по таймеру от входа, движение по пути, урон игроку при достижении выхода; броня (физ/маг), статус-эффекты (slow, poison, jade_poison).
- **Фазы:** BUILD (до 5 башен) → TOWER_SELECTION (выбор 2, остальные в стены) → WAVE (враги и бой) → снова BUILD.
- **UI:** HUD (здоровье, волна, башни, убийства, «Рецепты (B)», индикатор фазы, скорость, пауза), InfoPanel (инфо, кнопка «Сохранить»), Recipe Book (таблица крафта).

## Что происходит по шагам

1. **Старт:** GameManager создаёт ECS, HexMap, загружает JSON (башни, враги, волны, лут), генерирует руду, создаёт EnergyNetworkSystem. Main загружает GameRoot; GameRoot создаёт системы и рендереры, рисует карту.
2. **BUILD:** игрок кликает по гексу — ставится башня (тип по волне/луту или дебаг-клавишам). Майнеры на руде и соседние башни связываются энергосетью. После 5 башен фаза переключается в SELECTION.
3. **SELECTION:** игрок отмечает до 2 башен кнопкой «Сохранить» в InfoPanel или кликом. Майнеры считаются выбранными по умолчанию. Клик по индикатору фазы или выбор второй башни запускает переход в WAVE: невыбранные временные башни удаляются и заменяются стенами, энергосеть пересобирается.
4. **WAVE:** WaveSystem создаёт сущность волны, считает путь через чекпоинты, спавнит врагов по таймеру. MovementSystem двигает врагов по пути; при достижении выхода — урон игроку, сущность удаляется. CombatSystem ищет цели, создаёт снаряды/лазеры, списывает энергию с руды. ProjectileSystem двигает снаряды, при попадании наносит урон (броня, статусы). StatusEffectSystem обновляет таймеры slow/poison. Когда все враги заспавнены и убиты — волна завершена, фаза переключается в BUILD.
5. **Рендеринг:** EntityRenderer (башни, враги, снаряды, лазеры, подсветка гексов, линии майнер–стена), WallRenderer (стены и связи), OreRenderer, EnergyLineRenderer, AuraRenderer, TowerPreview. Данные берутся из ECS и HexMap.

## Технологии и структура

- **Core (без Godot):** ECS, Hex/HexMap/Pathfinding, системы (input, wave, movement, combat, projectile, status_effect, aura, crafting, volcano, beacon), energy_network, ore_generation. Крафтованные башни: Silver, Malachite, Volcano, Lighthouse, Jade.
- **Godot adapter:** рендереры в `godot_adapter/rendering/`, UI в `godot_adapter/ui/`. Ввод обрабатывается в GameRoot и передаётся в InputSystem (очередь команд).
- **Autoload:** Config (константы, цвета, load_json), GameManager (ECS, карта, данные, энергосеть, API), Profiler (опционально).

Подробнее: `docs/00-overview.md`, `docs/01-architecture.md`, `README.md`. Аудит систем и рефакторинг: `SYSTEMS_AUDIT.md`, `REFACTOR_ANALYSIS_SURFACE.md`.
