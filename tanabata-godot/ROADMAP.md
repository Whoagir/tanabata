# Roadmap - Tanabata Godot

## Что уже сделано (Этап 0)

### Архитектура и структура
- [x] Создана полная структура проекта (core/godot_adapter/data/assets/scenes/autoload)
- [x] Настроен project.godot с автозагрузкой
- [x] Создан README.md с описанием архитектуры

### Core (Чистая симуляция)
- [x] **Config.gd** - все константы из Go проекта
- [x] **GameTypes.gd** - все энумы и типы (GamePhase, TowerType, AttackType, DamageType, EventType)
- [x] **Hex.gd** - полная гексагональная математика (осевые координаты, расстояния, соседи, линии)
- [x] **HexMap.gd** - карта с процедурной генерацией (7 этапов)
- [x] **ECSWorld.gd** - полная ECS система с ~40 типами компонентов
- [x] **GameManager.gd** - главный менеджер с fixed timestep, загрузкой данных, событийной системой

### Данные
- [x] Скопированы все JSON файлы из Go проекта:
  - towers.json (все башни)
  - enemies.json (все враги)
  - recipes.json (5 рецептов крафта)
  - loot_tables.json (таблицы дропа)
  - waves.json (10 волн)

### Сцены
- [x] **main.tscn** - главная сцена с горячими клавишами
- [x] **game_root.tscn** - игровой корень со слоями (hex/tower/enemy/projectile/effect/ui)
- [x] Базовый рендеринг карты (Polygon2D для гексов)
- [x] Управление камерой (WASD, zoom)

---

## Этап 1: ECS Компоненты и базовые системы (1-2 недели)

### Приоритет 1: Компоненты
- [ ] Создать структуры данных для всех компонентов:
  - [ ] `Position`, `Velocity`, `Health`, `Renderable`
  - [ ] `Tower`, `Combat`, `Turret`
  - [ ] `Enemy`, `Path`
  - [ ] `Projectile`
  - [ ] `Ore`
  - [ ] Статус-эффекты (Slow, Poison, Aura, JadePoison)

### Приоритет 2: Базовые системы
- [ ] **PathfindingSystem** - A* алгоритм для гексов
- [ ] **MovementSystem** - движение врагов по пути
- [ ] **CombatSystem** - базовая атака башен
- [ ] **ProjectileSystem** - полет снарядов
- [ ] **OreSystem** - истощение руды

### Приоритет 3: Рендеринг (Adapter)
- [ ] **HexRenderer** - улучшенный рендеринг гексов
- [ ] **TowerRenderer** - спрайты башен
- [ ] **EnemyRenderer** - спрайты врагов (AnimatedSprite2D)
- [ ] **ProjectileRenderer** - визуализация снарядов

---

## Этап 2: Базовый геймплей (2-3 недели)

### Фаза BUILD_STATE
- [ ] Размещение башен на карте
- [ ] Проверка валидности размещения
- [ ] Визуальная подсветка доступных гексов
- [ ] Удаление башен (ПКМ)
- [ ] Лимит 5 башен в фазе

### Фаза WAVE_STATE
- [ ] Спавн врагов по таймеру
- [ ] Движение врагов через чекпоинты
- [ ] Атака башен по врагам
- [ ] Полет снарядов
- [ ] Нанесение урона (с учетом брони)
- [ ] Смерть врагов (+ опыт игроку)
- [ ] Достижение Exit (урон игроку)

### Фаза TOWER_SELECTION_STATE
- [ ] Выбор 2 башен для сохранения
- [ ] Остальные превращаются в стены
- [ ] Upgrade (2→1) и (4→1)

### Система волн
- [ ] WaveSystem - спавн врагов
- [ ] Определение волны (1-10, затем цикл 6-10)
- [ ] Распределение урона между врагами
- [ ] Переход между фазами

---

## Этап 3: Энергосеть (1-2 недели)

### Руда
- [ ] **OreGenerationSystem** - процедурная генерация 3 жил
- [ ] Визуализация руды (пульсация, цвет)
- [ ] Истощение руды при выстрелах
- [ ] Бонус от количества руды (множитель урона)

### Энергосеть
- [ ] **EnergyNetworkSystem** - MST алгоритм (Крускал)
- [ ] Правила соединения:
  - Обычные башни: расстояние 1
  - Шахтеры: расстояние 3 на одной линии
- [ ] Инкрементальное добавление башни
- [ ] Переподключение при удалении
- [ ] Визуализация линий (Line2D)
- [ ] Деградация энергии (множитель по длине пути)
- [ ] Активация/деактивация башен

### Визуализация
- [ ] Линии энергии (золотистые)
- [ ] Импульсы при выстрелах
- [ ] Подсветка неактивных башен

---

## Этап 4: Крафт и статус-эффекты (2-3 недели)

### Система крафта
- [ ] **CraftingSystem** - обнаружение комбинаций
- [ ] Автопоиск возможных рецептов
- [ ] Ручной выбор башен (Shift+Click)
- [ ] Комбинирование (3→1)
- [ ] Upgrade (2→1, 4→1)
- [ ] Downgrade (риск, случайная башня уровнем ниже)
- [ ] UI: книга рецептов (B)

### Статус-эффекты
- [ ] **StatusEffectSystem**
- [ ] SlowEffect - замедление
- [ ] PoisonEffect - DOT урон
- [ ] JadePoisonContainer - стакующийся яд
- [ ] AuraEffect - ускорение атаки

### Башни-ауры
- [ ] **AuraSystem**
- [ ] DE башня - ускорение x2.0
- [ ] Радиус 2 гекса
- [ ] Стакование аур (x2 * x2 = x4)
- [ ] Пересчет при размещении/удалении

---

## Этап 5: Специальные башни (1-2 недели)

### TOWER_SILVER (Лазер)
- [ ] Мгновенное попадание
- [ ] Визуализация луча (0.15 сек)
- [ ] Высокий урон

### TOWER_MALACHITE (Сплит + Взрыв)
- [ ] 3 снаряда
- [ ] Impact Burst при попадании
- [ ] Радиус взрыва 1.5 гекса
- [ ] До 4 вторичных целей

### TOWER_VOLCANO (AOE)
- [ ] **VolcanoSystem**
- [ ] Периодический урон (4 тика/сек)
- [ ] Радиус 2 гекса
- [ ] Визуальные кольца

### TOWER_LIGHTHOUSE (Маяк)
- [ ] **BeaconSystem**
- [ ] Вращающийся луч (1.5 рад/сек)
- [ ] Сектор 90 градусов
- [ ] Высокий DPS (24 тика/сек)
- [ ] Визуализация сектора

### TOWER_JADE (Стакующийся яд)
- [ ] Эллипсоидные снаряды
- [ ] Независимые стаки яда (5 сек)
- [ ] Суммирование урона + замедления
- [ ] Формула: (10 * stacks) * (1.1 ^ (stacks-1))

---

## Этап 6: UI и визуальные эффекты (1-2 недели)

### HUD
- [ ] Здоровье игрока (шкала)
- [ ] Уровень и опыт (круговая шкала)
- [ ] Номер волны
- [ ] Индикатор фазы
- [ ] Кнопка паузы
- [ ] Кнопка скорости (1x/2x/4x)
- [ ] Индикатор режима U
- [ ] Индикаторы рудных жил (3 шкалы)

### Информационные панели
- [ ] InfoPanel при клике на башню/врага
- [ ] Показать параметры (урон, скорость, броня)
- [ ] Шкалы вместо цифр

### Книга рецептов
- [ ] UI окно с рецептами
- [ ] Иконки башен
- [ ] Подсветка доступных рецептов
- [ ] Фильтрация

### Визуальные эффекты
- [ ] DamageFlash - вспышка при уроне
- [ ] Лазеры (луч)
- [ ] AOE эффекты (кольца)
- [ ] Взрывы (частицы)
- [ ] Пульсация руды
- [ ] Импульсы энергии

### Звуки (опционально)
- [ ] Выстрелы башен
- [ ] Попадания
- [ ] Смерть врагов
- [ ] Размещение башен
- [ ] Крафт
- [ ] Фоновая музыка

---

## Этап 7: Полировка и оптимизация (1 неделя)

### Оптимизация
- [ ] Frustum culling для рендеринга
- [ ] Object pooling для снарядов
- [ ] Batch rendering где возможно
- [ ] Оптимизация pathfinding (кэш)

### Балансировка
- [ ] Тестирование всех башен
- [ ] Тестирование всех врагов
- [ ] Баланс энергосети
- [ ] Баланс волн

### Качество жизни
- [ ] Автосохранение
- [ ] Настройки (громкость, качество)
- [ ] Туториал (опционально)
- [ ] Подсказки

---

## Этап 8: Мультиплеер (после основной игры)

### Архитектура
- [ ] Server Authoritative
- [ ] Синхронизация состояния
- [ ] Протокол команд

### Детерминизм
- [ ] Fixed timestep (уже есть)
- [ ] PRNG с seed
- [ ] Воспроизводимость

### Сеть
- [ ] Lobby система
- [ ] Матчмейкинг
- [ ] Реплеи

---

## Текущие приоритеты

### Сейчас (неделя 1-2):
1. Структура проекта
2. ECS архитектура
3. Гексагональная карта
4. Pathfinding (A*)
5. Базовые компоненты
6. Рендеринг врагов и башен

### Следующие шаги:
- Реализовать PathfindingSystem (A* через чекпоинты)
- Создать базовые визуальные ресурсы (спрайты)
- Реализовать WaveSystem и MovementSystem
- Начать тестировать геймплей

---

## Критерии готовности MVP

### Минимальный продукт должен иметь:
- [x] Процедурная генерация карты
- [ ] Размещение башен
- [ ] Спавн и движение врагов
- [ ] Атака башен
- [ ] Снаряды и урон
- [ ] Смерть врагов
- [ ] Волны (хотя бы первые 5)
- [ ] Энергосеть (базовая)
- [ ] Простой UI
- [ ] 3 фазы игры

### После MVP:
- Все остальные механики (крафт, спец. башни, статусы)
- Полноценный UI
- Визуальные эффекты
- Звуки
- Полировка

---

## Полезные ресурсы

### Гексагональные сетки
- https://www.redblobgames.com/grids/hexagons/
- https://www.redblobgames.com/pathfinding/a-star/

### ECS паттерн
- https://github.com/SanderMertens/ecs-faq
- https://docs.godotengine.org/en/stable/tutorials/best_practices/

### Godot 2D
- https://docs.godotengine.org/en/stable/tutorials/2d/
- https://kidscancode.org/godot_recipes/4.x/

---

## Заметки для разработки

### Приоритеты:
1. **Геймплей сначала** - работающая игра важнее красивых эффектов
2. **Тестируй рано** - после каждой системы проверяй работу
3. **Итеративно** - не пытайся сделать все сразу
4. **Детерминизм** - fixed timestep, PRNG с seed, воспроизводимость

### Архитектурные правила:
1. **Core не знает о Godot** - только GDScript, математика, структуры
2. **Adapter использует Godot** - Node, Sprite2D, Camera2D, etc.
3. **Данные в JSON** - легко редактировать и балансировать
4. **Системы независимы** - через события, не напрямую

### Проблемы которые могут возникнуть:
1. **Производительность** - много сущностей на экране
   - Решение: Frustum culling, pooling, batch rendering
2. **Pathfinding** - тормозит при пересчете
   - Решение: Кэширование, A* оптимизация, ограничение пересчетов
3. **Энергосеть** - сложный граф
   - Решение: Инкрементальные обновления, не пересчитывать всю сеть
4. **UI** - много элементов
   - Решение: Минимализм, скрывать неактивные элементы
