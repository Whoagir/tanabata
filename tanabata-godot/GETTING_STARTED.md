# Getting Started - Tanabata Godot

## Что уже работает

После запуска проекта в Godot вы увидите:

- Процедурно сгенерированную гексагональную карту
- Entry (вход), Exit (выход) и 6 чекпоинтов
- Цвета гексов: вход (фиолетовый), выход (красный), чекпоинты (медь/бронза), обычные тайлы (тёмно-серый)
- Управление камерой (WASD, R/T zoom, Y — сброс; колесо мыши — PageUp/PageDown в настройках ввода)
- Размещение и снос башен (ЛКМ/ПКМ), фазы BUILD → SELECTION → WAVE, волны врагов, энергосеть, HUD и InfoPanel

## Запуск проекта

1. **Открой Godot 4.5+**
2. **Импортируй проект**: `tanabata-godot/project.godot`
3. **Запусти главную сцену**: `F5` или кнопка Play

## Горячие клавиши

### Игровые
- `F9` - Пауза/Возобновление
- `F10` - God Mode (враги не наносят урон)
- `F3` - Visual Debug Mode (показывает FPS, количество сущностей)
- `F12` - Вывести состояние игры в консоль

### Управление камерой
- `WASD` - Движение камеры
- `R` - Приблизить (zoom in)
- `T` - Отдалить (zoom out)
- `Y` - Сбросить zoom
- Колесико мыши — zoom (действия ui_page_up / ui_page_down; при необходимости привязать в Project Settings → Input)

### Уже реализовано
- `Space` — смена фазы (BUILD → SELECTION → WAVE)
- `P` — пауза (в game_root)
- `Shift + ЛКМ` — добавить башню в ручной выбор (крафт, в фазе SELECTION)
- `ЛКМ` — размещение башни / выбор объекта / переключение «сохранить» в SELECTION
- `ПКМ` — удаление башни (в BUILD)

### Планируемые
- `B` — книга рецептов, `U` — перетаскивание линий энергосети

## Структура проекта

```
tanabata-godot/
├── core/                      # Чистая логика (БЕЗ Godot зависимостей)
│   ├── ecs/                   # ECS система
│   │   └── ecs_world.gd       # Готово
│   ├── hexmap/                # Гексагональная карта
│   │   ├── hex.gd             # Готово
│   │   ├── hex_map.gd         # Готово
│   │   └── pathfinding.gd     # Готово (A*)
│   ├── types/
│   │   └── game_types.gd      # Готово (энумы)
│   ├── systems/               # input, wave, movement, combat, projectile, status_effect, aura, energy_network, ore_generation
│   └── utils/                 # union_find
│
├── godot_adapter/             # Интеграция с Godot
│   ├── rendering/             # entity, wall, ore, energy_line, aura, tower_preview, node_pool
│   └── ui/                    # game_hud, info_panel
│
├── data/                      # JSON данные
│   ├── towers.json            # Скопировано из Go проекта
│   ├── enemies.json           # Скопировано
│   ├── recipes.json           # Скопировано
│   ├── loot_tables.json       # Скопировано
│   └── waves.json             # Создано
│
├── assets/                    # Ресурсы (спрайты, звуки)
│   ├── sprites/               # Нужно добавить
│   ├── textures/              # Нужно добавить
│   ├── fonts/                 # Нужно добавить
│   └── sounds/                # Нужно добавить
│
├── scenes/                    # Сцены Godot
│   ├── main.tscn              # Готово
│   └── game_root.tscn         # Готово
│
└── autoload/                  # Синглтоны (автозагрузка)
    ├── config.gd              # Готово
    └── game_manager.gd        # Готово
```

## Что можно посмотреть в коде

### 1. Config.gd (autoload/config.gd)
Все константы игры из Go проекта:
- Размеры экрана, гексов
- Параметры симуляции (tick rate)
- Константы башен, врагов, волн
- Цвета UI и игровых объектов
- Загрузка JSON файлов

### 2. GameTypes.gd (core/types/game_types.gd)
Все энумы:
- `GamePhase` - фазы игры (BUILD, WAVE, SELECTION)
- `TowerType` - типы башен (ATTACK, MINER, WALL)
- `AttackType` - типы атак (PROJECTILE, LASER, AOE, BEACON)
- `DamageType` - типы урона (PHYSICAL, MAGICAL, PURE, SLOW, POISON)
- `EventType` - типы событий

### 3. Hex.gd (core/hexmap/hex.gd)
Полная гексагональная математика:
- Осевые координаты (Q, R)
- Преобразование в пиксельные координаты
- Расстояние между гексами
- Соседи (6 направлений)
- Получение гексов в радиусе
- Получение кольца гексов
- Линия между гексами
- Проверка "на одной линии"

### 4. HexMap.gd (core/hexmap/hex_map.gd)
Карта с генерацией:
- Процедурная генерация (7 этапов)
- Entry, Exit, Checkpoints
- Тайлы (проходимость, башни)
- Зоны исключения

### 5. Pathfinding.gd (core/hexmap/pathfinding.gd)
A* алгоритм:
- Поиск пути между гексами
- Путь через чекпоинты (Entry → CP1 → CP2 → ... → Exit)
- Проверка блокировки пути

### 6. ECSWorld.gd (core/ecs/ecs_world.gd)
ECS система:
- Создание/удаление сущностей
- ~40 типов компонентов
- Добавление/удаление компонентов
- Глобальное состояние игры

### 7. GameManager.gd (autoload/game_manager.gd)
Главный менеджер:
- Создание ECS, HexMap, EnergyNetworkSystem, загрузка JSON
- API: get_tower_def, get_enemy_def, get_wave_def, get_loot_table_for_level
- Управление паузой, скоростью времени, фазой
- Событийная система (dispatch_event) объявлена, пока не используется
- Примечание: системы вызываются из GameRoot._process, а не из update_simulation (массив systems пуст)

## Тестирование

### Консольные команды
В игре нажми `F12` чтобы вывести в консоль:
- Количество сущностей
- Количество тайлов на карте
- Информацию о Entry, Exit, Checkpoints
- Текущую фазу игры
- FPS и время игры

### Проверка карты
После запуска ты увидишь гексагональную карту. Проверь:
1. **Entry (фиолетовый)** — слева
2. **Exit (красный)** — справа
3. **6 чекпоинтов (медные/бронзовые)** — по периметру
4. **Обычные тайлы (тёмно-серые)** — основная карта

### Проверка камеры
- Подвигай камеру (WASD) - должна плавно двигаться
- Поприближай/отдали (R/T) - должен меняться zoom
- Сбрось zoom (Y) - должен вернуться к 1.0

## Следующие шаги

### Для разработки

1. **Добавь спрайты**
   - Создай простые placeholder спрайты для башен и врагов
   - Положи в `assets/sprites/`
   - Можно использовать простые геометрические фигуры

2. **Базовые системы** — уже есть: WaveSystem, MovementSystem, CombatSystem, ProjectileSystem, StatusEffectSystem, AuraSystem.

3. **Рендеринг** — EntityRenderer (башни, враги, снаряды, лазеры), WallRenderer, OreRenderer, EnergyLineRenderer, AuraRenderer, TowerPreview; пулы для врагов и снарядов.

4. **UI** — HUD (здоровье, волна, башни, убийства, индикатор фазы, скорость, пауза), InfoPanel (инфо о башне/враге, кнопка «Сохранить»).

### Для тестирования

1. **Проверь генерацию карты**
   - Запусти игру несколько раз
   - Карта должна каждый раз быть разной (разный seed)
   - Entry, Exit и чекпоинты должны быть на разных позициях

2. **Проверь pathfinding**
   - Путь пересчитывается при старте волны (WaveSystem). При постановке башни при выключенном fast_tower_placement проверяется _would_block_path в InputSystem.

3. **Проверь ECS**
   - F12 выводит состояние игры и статистику ECS (print_game_state в GameManager).

## Troubleshooting

### Проблема: Карта не отображается
**Решение**: Проверь что `main.tscn` установлена как главная сцена в project.godot.

### Проблема: Ошибки при загрузке JSON
**Решение**: Убедись что JSON файлы находятся в `data/` папке и правильно отформатированы.

### Проблема: Autoload не работает
**Решение**: Проверь `project.godot`, должны быть строки:
```ini
[autoload]
Config="*res://autoload/config.gd"
GameManager="*res://autoload/game_manager.gd"
```

### Проблема: Камера не двигается
**Решение**: Проверь что в `game_root.gd` есть Camera2D и функция `_update_camera_controls()`.

## Полезные ссылки

- **PROJECT_OVERVIEW.md** — краткое описание: о чём игра, что есть, что происходит
- **README.md** — архитектура и структура проекта
- **docs/** — подробная документация по системам, рендерингу, UI (см. docs/README.md)
- **core/components/README.md** — описание компонентов ECS
- **SYSTEMS_AUDIT.md** — аудит использования систем (оценки 0–100)
- **REFACTOR_ANALYSIS_SURFACE.md** — поверхностный анализ для рефакторинга

## Советы

1. **Изучай Go код параллельно** - многие механики уже реализованы там, можно переносить
2. **Используй print() для отладки** - в GDScript это очень удобно
3. **Тестируй по частям** - не пытайся сделать все сразу
4. **Читай документацию Godot** - https://docs.godotengine.org/
5. **Не бойся экспериментировать** - это твой проект!

## Цель проекта

Перенести полнофункциональную Tower Defense игру с Go (3D) на Godot (2D), сохранив все механики:
- Гексагональная карта
- Энергосеть (MST)
- Крафт башен
- Процедурная генерация руды
- Волны врагов
- Статус-эффекты
- Специальные башни (Вулкан, Маяк, Jade, etc.)

Удачи в разработке!
