# Система выделения и выбора

## Обзор

Реализована улучшенная система выделения, основанная на Go-версии проекта, с правильной визуализацией для разных типов сущностей.

## Типы выделения

### 1. **Выбор (Highlight)** - `is_highlighted`
Используется для просмотра информации о сущности.
- **Одна сущность** может быть выбрана в данный момент
- При клике на новую сущность, предыдущая автоматически снимается

### 2. **Селект (Selection)** - `is_selected`
Используется для **сохранения башен** при переходе из фазы BUILD в WAVE.
- Только для башен
- До **2 башен** можно отметить для сохранения
- Майнеры (`TOWER_MINER`) сохраняются **автоматически**
- Остальные башни без селекта превращаются в стены

### 3. **Выделение для крафта (Manual Selection)** - `is_manually_selected`
Используется для выбора **нескольких башен** для крафта (будущий функционал).
- **Несколько башен** могут быть выделены одновременно
- Выбор производится с зажатым Shift + ЛКМ

## Визуализация

### Неподвижные сущности (башни, руда, стены)
**Подсветка гекса** — полупрозрачный шестиугольник под сущностью (entity_renderer, hex_highlight_layer):
- **Серый** — обычный выбор (`is_highlighted`)
- **Голубой** — селект для сохранения (`is_selected`)
- **Фиолетовый** — выделение для крафта (`is_manually_selected`)

### Движущиеся сущности (враги)
**Обводка** - контур вокруг сущности:
- **Желтая обводка** (80% прозрачность) - при выборе

### Майнеры (особый случай)
Майнеры имеют **базовую обводку** всегда видимую:
- **40% прозрачность** - базовое состояние (без выбора)
- **70% прозрачность** - при выборе/селекте (ярче)
- Это позволяет видеть майнеры на карте даже без выбора

### Атакующие башни и стены
**Обводка только при выборе** (жёлтая, одна и та же при любом типе выделения в коде):
- При is_highlighted / is_selected / is_manually_selected — жёлтая обводка (70% прозрачность), видимая.

## Управление

### Просмотр информации
- **ЛКМ** по сущности → показывает InfoPanel + подсветка
- **ЛКМ** по пустому месту → закрывает панель + снимает подсветку

### Селект (сохранение башен)
**Фаза TOWER_SELECTION_STATE:**
- **ЛКМ** по башне → переключает `is_selected`
- Можно выбрать до 2 башен
- Майнеры выбраны по умолчанию

### Выделение для крафта (будущее)
- **Shift + ЛКМ** → добавить/убрать башню из выделения
- Можно выделить несколько башен одновременно

## Формат уровней

### Формат 1: Б А А А А
- **Б** (майнер) - **автоматически** сохранен (`is_selected = true`)
- Нужно **вручную выбрать еще 1** башню для сохранения
- Итого: 2 сохраненных, 3 превращаются в стены

### Формат 2: А А А А А
- Нужно **вручную выбрать 2** башни для сохранения
- Итого: 2 сохраненных, 3 превращаются в стены

## Технические детали

### Компоненты ECS

**Tower:**
```gdscript
{
    "is_highlighted": bool,        # Выбрана для просмотра
    "is_selected": bool,           # Выбрана для сохранения
    "is_manually_selected": bool   # Выбрана для крафта
}
```

**Enemy:**
```gdscript
{
    "is_highlighted": bool  # Выбран для просмотра
}
```

**Ore:**
```gdscript
{
    "is_highlighted": bool  # Выбрана для просмотра
}
```

### Рендеринг

**Hex Highlight Layer** (`entity_renderer.gd`):
- z_index: -10 (под всеми остальными слоями)
- Полупрозрачная заливка + обводка гекса
- Автоматически создается/удаляется при изменении флагов

**Outline** (обводка):
- Часть Node2D башни/врага
- Управляется через `_update_tower_highlight()`
- Для майнеров: всегда видна, меняется только прозрачность

### Измененные файлы

1. **`godot_adapter/rendering/entity_renderer.gd`**
   - Добавлен `hex_highlight_layer` для подсветки гексов
   - Функция `_render_hex_highlights()` - рендеринг подсветки
   - Изменена логика `_update_tower_highlight()` - правильная обводка
   - Добавлена обводка для врагов в `_create_pooled_enemy()`

2. **`core/systems/input_system.gd`**
   - Обновлен `select_tower()` - поддержка врагов и руды
   - Обновлен `clear_highlight()` - очистка для всех типов
   - Обновлен `_get_entity_at_hex()` - поиск руды
   - Обновлен `handle_mouse_click()` - выделение при клике

3. **`core/systems/wave_system.gd`**
   - Добавлен флаг `is_highlighted` для врагов

4. **`core/systems/ore_generation_system.gd`**
   - Добавлен флаг `is_highlighted` для руды

## Сравнение с Go версией

### Совпадения
- Три флага: `IsHighlighted`, `IsSelected`, `IsManuallySelected`
- Hex highlight для неподвижных сущностей
- Обводка для движущихся
- Майнеры сохраняются автоматически

### Улучшения относительно Go
- Обводка у майнеров всегда видна (40% базовая)
- Более мягкие цвета (60% вместо 100%)
- Hex highlight с градиентом (заливка + обводка)

## Будущие улучшения

1. **Крафт-система**
   - Shift + ЛКМ для множественного выделения
   - Визуализация возможных крафтов

2. **Кнопка селекта в InfoPanel** — реализовано: "СОХРАНИТЬ" / "ОТМЕНИТЬ" для временных башен в фазе SELECTION.

3. **Автопереход в WAVE** — реализовано: после выбора второй башни в InfoPanel происходит финализация и переход в WAVE.
