# Статус проекта Tanabata Godot

**Дата создания:** 25 января 2026  
**Версия:** 0.2.x  
**Статус:** Базовый цикл игры реализован (BUILD → SELECTION → WAVE), волны, бой, энергосеть, руда, UI

## Актуальное состояние (кратко)

Реализованы: все основные системы (input, wave, movement, combat, projectile, status_effect, aura), энергосеть (MST, перехват майнер-майнер), генерация руды при старте, рендеринг (entity, wall, ore, energy_line, aura, tower_preview, attack_link, crafting_visual, wall), HUD, InfoPanel и Recipe Book, три фазы (BUILD_STATE → TOWER_SELECTION_STATE → WAVE_STATE), выбор и сохранение башен. **Крафт реализован:** CraftingSystem, пересчёт комбинаций при переходе SELECTION → WAVE, игрок крафтит в фазе выбора кнопкой по подсвеченной группе. **Спецбашни:** Volcano (AoE), Lighthouse (Beacon), системы и рендер работают. Событийная система (dispatch_event) не используется. Подробный аудит — SYSTEMS_AUDIT.md, риски расширения — EXTENSION_RISKS.md, план разработки — DEVELOPMENT_PLAN.md.

---

## Что реализовано (Этап 0 - Фундамент)

### Архитектура

- [x] **Полная структура проекта** с разделением на:
  - `core/` - чистая симуляция (без зависимостей от Godot)
  - `godot_adapter/` - интеграция с Godot (рендеринг, ввод, UI)
  - `data/` - JSON данные
  - `assets/` - ресурсы
  - `scenes/` - сцены Godot
  - `autoload/` - синглтоны

- [x] **Настроенный project.godot** с:
  - Автозагрузкой Config и GameManager
  - Правильным разрешением (1200x993)
  - Forward+ рендером
  - Настройками ввода

### Core (Чистая симуляция)

#### Config.gd
- Все константы из Go проекта:
  - Экран и рендеринг (размеры, hex_size)
  - Игровая логика (tick_rate, health, лимиты)
  - Башни и враги
  - Энергосеть (радиусы, деградация)
  - Руда (мощность, бонусы)
  - Снаряды и эффекты
  - Камера и UI
  - Цветовая палитра
- Утилиты:
  - Загрузка JSON
  - Расчет бонуса руды

#### GameTypes.gd
- Все игровые энумы:
  - `GamePhase` (BUILD_STATE, WAVE_STATE, TOWER_SELECTION_STATE — в коде; в доке часто BUILD / WAVE / SELECTION)
  - `TowerType` (ATTACK, MINER, WALL)
  - `AttackType` (PROJECTILE, LASER, AOE, BEACON, NONE)
  - `DamageType` (PHYSICAL, MAGICAL, PURE, SLOW, POISON, INTERNAL)
  - `EventType` (9 типов событий)
  - `ProjectileVisualType` (SPHERE, ELLIPSE)
- Утилиты для преобразования в строки
- Получение цвета по типу урона

#### Hex.gd
Полная гексагональная математика:
- Осевые координаты (Q, R) с вычисляемой S
- Преобразование гекс ↔ пиксель (pointy-top)
- Округление дробных координат
- Расстояние между гексами (манхэттенское)
- Соседи (6 направлений)
- Получение гексов в радиусе
- Получение кольца гексов
- Линия между гексами
- Проверка "на одной линии" (для энергосети)
- Утилиты (equals, hash, to_string, to_key, from_key)

#### HexMap.gd
Гексагональная карта с генерацией:
- Класс `Tile` с полями:
  - hex, passable, can_place_tower, has_tower, tower_id
- Управление тайлами (get, set, has, is_passable, can_place_tower)
- **Процедурная генерация** (7 этапов из ПОЛНЫЙ_АНАЛИЗ_МЕХАНИК.md):
  1. Базовая гексагональная сетка
  2. Установка Entry/Exit
  3. Генерация 6 чекпоинтов (случайный порядок)
  4. Модификация секций (упрощенная)
  5. Обработка углов (упрощенная)
  6. Постобработка (удаление изолированных, добавление окруженных)
  7. Зоны исключения (радиус 3 от важных точек)
- Entry, Exit, Checkpoints
- Размещение/удаление башен
- Получение всех тайлов/гексов

#### Pathfinding.gd
A* алгоритм для гексов:
- Поиск кратчайшего пути между двумя гексами
- Эвристика (манхэттенское расстояние)
- Учет проходимости тайлов
- **Путь через чекпоинты**: Entry → CP1 → ... → CPN → Exit
- Проверка блокировки пути (для валидации размещения башен)
- Восстановление пути из came_from
- Дебаг-утилиты

#### ECSWorld.gd
Полная ECS система:
- Создание/удаление сущностей
- **~40 типов компонентов**:
  - Базовые (Position, Velocity, Health, Renderable)
  - Башни (Tower, Combat, Turret)
  - Враги (Enemy, Path)
  - Снаряды (Projectile)
  - Руда (Ore)
  - Статус-эффекты (Slow, Poison, JadePoison, Aura)
  - Визуальные (DamageFlash, Laser, AoeEffect)
  - Линии энергосети (EnergyLine)
  - Текст (Text)
  - Крафт (Combinable)
  - Волны (Wave)
  - Игрок (PlayerState)
  - Спецбашни (Beacon, BeaconSector, Volcano)
  - Выбор (ManualSelectionMarker)
  - Состояние игры (GameState)
- Добавление/удаление компонентов
- Проверка наличия компонента
- Инициализация состояния игры
- Дебаг-статистика

### Autoload (Синглтоны)

#### GameManager.gd
Главный менеджер игры:
- **ECS и HexMap** инициализация
- **Fixed Timestep симуляция** (30 тиков/сек)
  - Накопитель для детерминизма
  - Ограничение delta (предотвращение спирали смерти)
  - Учет паузы и скорости игры
- **Загрузка JSON данных**:
  - towers.json → tower_defs
  - enemies.json → enemy_defs
  - recipes.json → recipe_defs
  - loot_tables.json → loot_table_defs
  - waves.json → wave_defs
- **Событийная система**:
  - Signal event_dispatched
  - Диспетчер событий
- **API для систем**:
  - get_tower_def(), get_enemy_def()
  - get_loot_table_for_level()
  - get_wave_def() (с циклом 6-10 после волны 10)
- **Управление игрой**:
  - Пауза/возобновление
  - Скорость игры (1x/2x/4x)
  - Получение/установка фазы
- **Дебаг**:
  - God Mode
  - Visual Debug Mode
  - Вывод состояния игры

### Данные (JSON)

- [x] **towers.json** - 17 башен (9 базовых + 5 крафтовых + 2 служебных)
- [x] **enemies.json** - 7 типов врагов (+ босс)
- [x] **recipes.json** - 5 рецептов крафта
- [x] **loot_tables.json** - таблица дропа для уровня 1
- [x] **waves.json** - 10 волн (с циклом 6-10)

### Сцены

#### main.tscn + main.gd
Главная сцена:
- Инициализация GameRoot
- Глобальные горячие клавиши:
  - F9 - Пауза
  - F10 - God Mode
  - F3 - Visual Debug
  - F12 - Вывод состояния

#### game_root.tscn + game_root.gd
Игровой корень:
- **Camera2D** с управлением:
  - WASD - движение
  - R/T - zoom
  - Y - reset zoom
- **Слои** (Node2D):
  - HexLayer (гексы)
  - TowerLayer (башни)
  - EnemyLayer (враги)
  - ProjectileLayer (снаряды)
  - EffectLayer (эффекты)
- **UILayer** (CanvasLayer для UI)
- **Рендеринг карты**: Polygon2D гексов, Line2D обводка; цвета из Config (entry, exit, checkpoints, обычные)
- Геометрия гекса (pointy-top)
- Visual Debug отображение (FPS, количество сущностей)

### Документация

- [x] **README.md** - полное описание архитектуры, структуры, плана разработки
- [x] **ROADMAP.md** - детальный план по этапам с приоритетами
- [x] **GETTING_STARTED.md** - инструкция по запуску и использованию
- [x] **core/components/README.md** - описание всех ~40 компонентов ECS с примерами
- [x] **PROJECT_STATUS.md** (этот файл) - текущий статус проекта

---

## В планах

- Подключение событийной системы (dispatch_event) — по необходимости
- Дальнейшее развитие по приоритетам из DEVELOPMENT_PLAN.md (крафт с касания, уровни, летающие враги, новые башни, способности врагов и т.д.)

---

## Прогресс по механикам

### Из ПОЛНЫЙ_АНАЛИЗ_МЕХАНИК.md:

| Механика | Статус | Примечание |
|----------|--------|-----------|
| **Гексагональная карта** | 100% | Полностью реализована |
| **Процедурная генерация** | 90% | Основные этапы, нужна доработка секций |
| **Pathfinding (A*)** | 100% | Готово с чекпоинтами |
| **ECS архитектура** | 100% | Все компоненты определены |
| **Fixed Timestep** | 100% | Реализовано (30 Hz) |
| **Загрузка данных** | 100% | Все JSON файлы |
| Система волн | | WaveSystem |
| Движение врагов | | MovementSystem по path |
| Боевая система | | CombatSystem (снаряды/лазеры) |
| Снаряды | | ProjectileSystem |
| Энергосеть | | MST, перехват майнер-майнер |
| Руда | | OreGenerationSystem, расход в комбате |
| Крафт | | CraftingSystem, рецепты, кнопка в SELECTION, Recipe Book (B) |
| Статус-эффекты | | Slow, poison, jade_poison |
| Спецбашни | | Volcano (AoE), Lighthouse (Beacon), системы и рендер |
| UI | | HUD, InfoPanel |
| Визуальные эффекты | | Лазеры, вспышки урона, пулы |

**Легенда:** Готово | Не начато

---

## MVP (текущий)

- [x] Карта, ECS, размещение/снос башен, волны, движение, бой, снаряды, урон, смерть врагов, 3 фазы, HUD, энергосеть, руда, статус-эффекты, выбор башен
- [x] Крафт (Silver, Malachite, Volcano, Lighthouse, Jade), спецбашни (Volcano, Beacon), книга рецептов (B)
- Дальнейшие цели — см. DEVELOPMENT_PLAN.md

---

## Метрики проекта

### Код:
- **Строк кода:** ~3000 (GDScript)
- **Файлов:** 15 (.gd) + 2 (.tscn) + 5 (.json)
- **Компонентов:** ~40
- **Систем (запланировано):** ~15

### Данные:
- **Башен:** 17 (9 базовых + 5 крафтовых + 3 служебных)
- **Врагов:** 7 типов
- **Рецептов:** 5
- **Волн:** 10 (с циклом)

### Архитектура:
- **Разделение:** Core (логика) / Adapter (Godot)
- **Детерминизм:** Fixed timestep 30 Hz
- **Данные:** JSON (легко редактировать)

---

## Ближайшие задачи

Актуальный приоритизированный план — в **DEVELOPMENT_PLAN.md**. Там же: крафт с касания, уровни игрока/башен, летающие враги, новые башни (кварц, минус-армор, второй уровень крафта), способности врагов и др.

---

## Известные проблемы

### Критичные:
- Нет

### Некритичные:
- Генерация карты не полностью реализована (этапы 4-5 упрощены)
- Нет спрайтов для визуализации
- Колесико мыши для zoom не подключено

### Технический долг:
- Нужно добавить unit-тесты (при желании)
- Нужно оптимизировать рендеринг гексов (слишком много Polygon2D)

---

## Заметки для разработчика

### Что работает хорошо:
- Архитектура четкая и расширяемая
- Разделение Core/Adapter работает отлично
- Гексагональная математика точная
- ECS гибкая и быстрая
- Fixed timestep детерминирован

### Что нужно улучшить:
- Генерация карты (этапы 4-5)
- Нужны placeholder ассеты
- Нужна система для удобной отладки (визуализация компонентов)

### Ближайшие риски:
- Производительность при большом количестве сущностей (сотни врагов/снарядов)
  - **Митигация:** Frustum culling, object pooling, batch rendering
- Сложность энергосети (MST алгоритм)
  - **Митигация:** Инкрементальные обновления, не пересчитывать всю сеть
- Pathfinding может тормозить
  - **Митигация:** Кэширование путей, ограничение пересчетов

---

## Достижения

- **Полная архитектура** с разделением ответственности
- **Все механики описаны** в виде компонентов
- **Процедурная генерация** работает
- **Pathfinding** с чекпоинтами реализован
- **Fixed timestep** для детерминизма
- **Все данные** из Go проекта перенесены

---

## Следующий шаг

Следовать приоритетам из **DEVELOPMENT_PLAN.md**. Первый блок «Срочно и важно»: крафт с касания, осмысленные уровни игрока/башен, летающие враги, вышка кварц, способности врагов, слияние вышек в BUILD, вышки на минус армор.

---

## Контакты и ресурсы

### Документация:
- README.md - архитектура
- ROADMAP.md - план разработки
- GETTING_STARTED.md - инструкция по запуску
- core/components/README.md - компоненты ECS

### Референсы:
- tanabata-main/ - Go проект (источник механик)
- ПОЛНЫЙ_АНАЛИЗ_МЕХАНИК.md - детальное описание

### Внешние ресурсы:
- https://www.redblobgames.com/grids/hexagons/
- https://docs.godotengine.org/

---

**Дата обновления:** 25 января 2026  
**Следующий milestone:** Этап 1 - Базовые системы  
**ETA:** 1-2 недели при активной разработке
