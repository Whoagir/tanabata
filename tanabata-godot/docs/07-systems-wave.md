# WaveSystem (система волн)

## Назначение

Управляет волнами врагов: старт, спавн по таймеру, проверка завершения волны. Итоги урона и начисление MVP при завершении.

## Когда работает

Только в фазе WAVE. В BUILD и SELECTION ничего не делает.

## Старт волны

Берётся определение волны по номеру (из JSON). Рассчитывается путь через чекпоинты с учётом башен. Для **летающих** врагов путь строится с условной вставкой центра: между чекпоинтами i→i+1 центр вставляется, если этот отрезок длиннее отрезка i+1→i+2; при входе — через центр, если чекпоинт 1 входит в два самых дальних от входа; при выходе — через центр, если чекпоинт 6 входит в два самых дальних от выхода. Создаётся сущность волны с полями: номер волны, ID врага(ов), количество, интервал спавна, таймер, путь. Урон по игроку распределяется между врагами (damage_per_enemy). Поддержка смешанных волн (enemies[]), health_multiplier_flying / health_multiplier_ground.

## Спавн врагов

Каждые spawn_interval секунд создаётся один враг. Позиция — Entry. Врагу задаются: позиция, скорость, здоровье (с учётом health_multiplier или health_multiplier_flying/ground), броня, путь, **abilities** и **evasion_chance** из определения волны. Для способностей blink, reflection, aggro при создании инициализируются таймеры/счётчики (см. StatusEffectSystem, MovementSystem). Хиллер и Танк получают свои пассивные способности (healer_aura, aggro) автоматически. Враги добавляются в ECS.

## Завершение волны

Когда все враги заспавнены (enemies_to_spawn = 0) и нет живых врагов — вызывается **log_wave_damage_report()**: сохранение last_wave_tower_damage, начисление **+1 MVP** первой по урону башне с mvp_level < 5 (только если волна не была пропущена — game_state.wave_skipped не true). Затем удаляются сущность волны и снаряды, восполнение руды за волну, пересборка энергосети, фаза → BUILD. При пропуске волны (переход WAVE→BUILD вручную через PhaseController) wave_skipped выставляется в true, log_wave_damage_report не вызывается — MVP не даётся.

## Подсчёт живых врагов

Проверяются сущности с компонентом enemy и health. Считаются только те, у кого current > 0.
