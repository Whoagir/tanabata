# Краткое описание игры и список механик

## Описание игры

**Tanabata** — 2D Tower Defense на гексагональной карте. Цикл: строительство (до 5 башен) → выбор 2 башен для сохранения → волна врагов. Башни питаются от энергосети майнеров на руде. Цель — не дать врагам дойти до выхода. Волны 1–39, крафт спецбашен по рецептам.

---

## Список механик

### Фазы
- Фаза **BUILD** — строительство.
- Фаза **SELECTION** — выбор башен для сохранения.
- Фаза **WAVE** — волна врагов.
- Переход BUILD → SELECTION → WAVE → BUILD (авто или клик по индикатору).
- Ручной переход на следующую фазу по клику на индикатор фазы.

### Размещение и снятие башен
- Размещение башни по ЛКМ на проходимый гекс с возможностью размещения.
- Снятие башни по ПКМ.
- Лимит: до 5 «обычных» башен за фазу BUILD (дебаг-башни не в счёт).
- После 5 башен — автоматический переход в SELECTION.
- Майнер можно ставить только на гекс с рудой.

### Выбор башен (SELECTION)
- Игрок отмечает 2 башни для сохранения (клик по башне).
- Невыбранные временные башни превращаются в стены.
- Майнеры считаются выбранными по умолчанию.
- Клик по индикатору фазы — переход в WAVE (финализация выбора).

### Типы башен
- **ATTACK** — атакующая башня (стреляет по врагам, тратит руду).
- **MINER** — майнер на руде, источник энергии в сети.
- **WALL** — стена, блокирует путь, не участвует в энергосети.

### Типы атак башен
- **PROJECTILE** — снаряд (полёт к цели, потиковая донаводка).
- **LASER** — мгновенный луч (опционально с замедлением).
- **AREA_OF_EFFECT** — Volcano, урон по области.
- **BEACON** — Lighthouse, вращающийся луч по секторам.
- **NONE** — нет атаки (аура, поддержка).

### Типы урона
- **PHYSICAL** — снижается физ. бронёй врага.
- **MAGICAL** — снижается маг. бронёй врага.
- **PURE** — игнорирует броню.
- **SLOW** — наложение замедления (движение).
- **POISON** — урон по времени (обычный яд).
- **INTERNAL** — внутренний (ауры и т.п.).

### Параметры атаки (params)
- **split_count** — число снарядов на выстрел (несколько целей).
- **slow_multiplier / slow_duration** — параметры замедления (лазер).
- **impact_burst** — Malachite: при попадании дополнительные снаряды с homing.
- **effect: JADE_POISON** — Jade: стакающийся яд (снижение регена).
- **bash_chance / bash_duration** — Изумруд: шанс обездвижить врага на время.

### Ауры башен
- Аура **speed_multiplier** — ускорение стрельбы союзных башен в радиусе (DE, Silver и др.).
- Аура **damage_bonus** — бонус урона союзным башням в радиусе (при наличии в данных).
- Учёт ауры в CombatSystem (fire_rate), расход руды за выстрел с коэффициентом для аур (Config).

### Энергосеть
- Связи между башнями: MST по приоритетам (майнер–майнер > майнер–атакер > атакер–атакер).
- Майнер–майнер: до 3 гексов по одной линии (на одной прямой).
- Соседи (1 гекс): любые пары майнер/атакер.
- Атакующая башня стреляет только при доступе к руде через сеть от майнеров.
- Пересборка сети при постановке/снятии башни и смене фазы.
- Майнер на линии между двумя майнерами — «перехват» (старая линия разрывается, две новые).

### Руда
- Процедурная генерация руды при старте карты (несколько жил, общая мощность в лимите).
- У каждого майнера — связь с гексом руды (ore): запас current_reserve, max_reserve.
- Пополнение запаса руды между волнами (при переходе WAVE → BUILD).
- Выстрел атакующей башни стоит **shot_cost** руды; списание с сети майнеров.
- Руда ниже порога — «истощена», майнер неактивен.
- HUD: индикатор руды сети (прогресс, при наведении на майнер — его сеть).

### Крафт
- Книга рецептов — клавиша **B**.
- Крафт в фазе SELECTION по подсвеченной группе руды (рецепт выбирается в книге).
- Рецепты заданы в recipes.json: входные башни/руда → выходная башня.
- Реализованные рецепты: Silver, Malachite, Volcano, Lighthouse, Jade, Изумруд (DA2+TE1+NA1).

### Волны
- Волны 1–39 заданы в waves.json (или константы/инициализация в wave_system).
- Параметры волны: враг(ы), количество, spawn_interval, реген, health_multiplier / health_override, abilities, evasion_chance.
- Смешанные волны: массив enemies[] с разными типами и долями.
- Отдельные множители HP для летающих и наземных (health_multiplier_flying / health_multiplier_ground).
- Спавн по таймеру (каждые spawn_interval сек один враг).
- Завершение волны: все заспавнены и нет живых врагов → переход в BUILD.

### Враги (типы)
- Слабый 1/2, Обычный 1/2, Крепкий 1/2.
- Магический щит, Физический щит.
- Быстрый 1/2.
- Босс.
- Летающий, Летающий слабый/крепкий/быстрый.
- Хиллер (аура лечения), Танк (агрро).
- Параметры: health, speed, physical_armor, magical_armor, flying.

### Способности врагов (пассивные)
- **effect_immunity** — иммунитет к эффектам (slow, poison, слой и т.д.).
- **evasion** — шанс увернуться от попадания (evasion_chance на волне).
- **reactive_armor** — стаки брони и регена от полученных ударов.
- **kraken_shell** — сброс дебаффов при достижении порога полученного урона.
- **untouchable** — попавшая по врагу башня получает замедление.
- **hus** — реген до 250% при низком HP.
- **healer_aura** — +20 регена союзникам в радиусе 4 гекса (только у Хиллера).

### Способности врагов (активные)
- **rush** — ускорение на время, кулдаун 5 с.
- **disarm** — башни в радиусе не стреляют (на время).
- **blink** — телепорт на 8 гексов вперёд по пути, кулдаун 8 с, первый раз через 4 с.
- **reflection** — 4 слоя щита, каждый удар снимает 1 слой, кулдаун 5 с (отражает урон/эффекты пока есть слои).
- **aggro** — Танк: башни в радиусе 4 гекса бьют только этого врага, 2 с, кулдаун 5 с.

### Путь и движение врагов
- Путь: A* между чекпоинтами (Entry → Checkpoint 1…6 → Exit).
- Пересчёт пути при постановке/снятии башни (дебаунс).
- Летающие враги: условная вставка центра карты в путь (длинные отрезки, вход/выход).
- Движение по path.hexes с текущим индексом; к следующему чекпоинту при приближении.
- Эффективная скорость с учётом **slow** (множитель).
- **Bash** — обездвиживание: скорость = 0, блокируются рывок и блинк.
- Дойдя до выхода — урон игроку, сущность врага удаляется.

### Выбор цели (CombatSystem)
- Цель: живой враг в радиусе (range) башни, сортировка по расстоянию, до split_count целей.
- **Агрро**: если у какого-то врага активен aggro и башня в радиусе 4 от него — цель только этот враг (если в range).
- Энергия: проверка доступа к руде через сеть, запас >= shot_cost; иначе выстрел не производится.

### Урон и броня
- Формула снижения урона броней (физ/маг в зависимости от damage_type).
- **Evasion**: перед применением урона проверка roll_evasion; при успехе — промах (0 урона, без эффектов).
- Рефлекшн: при наличии слоёв reflection часть попаданий снимает слой и не наносит урон/эффект (в т.ч. яд).

### Снаряды (ProjectileSystem)
- Полёт к цели, обновление позиции каждый кадр.
- Потиковая донаводка: раз в HOMING_TICK_INTERVAL коррекция направления к цели (если в радиусе активации).
- Полный homing для осколков Malachite (impact_burst).
- При достижении цели: применение урона (с броней, evasion, reflection), наложение эффектов (slow, poison, JADE_POISON, bash), damage_flash на враге.
- Лазер: мгновенный урон по линии, без сущности снаряда; длительность отрисовки из Config.

### Статус-эффекты на врагах
- **Slow** — множитель скорости движения < 1 на время (Silver и др.).
- **Poison** — урон по времени (тик), длительность.
- **Jade poison** — стакающийся дебафф, снижение регена по стакам (Jade).
- **Bash** — обездвиживание на время, блокирует движение, рывок, блинк (Изумруд).
- Рефлекшн снимает один слой за попадание (в т.ч. от яда/эффектов).

### Volcano и Beacon
- **Volcano** (AREA_OF_EFFECT): периодический урон по области вокруг башни (VolcanoSystem).
- **Lighthouse** (BEACON): вращающийся луч, урон врагам в текущем секторе (BeaconSystem, beacon_sectors).

### MVP
- За волну ведётся учёт урона по башням (tower_damage_this_wave).
- По завершении волны (все враги убиты, не пропущена): башня с максимальным уроном получает +1 MVP (если у неё mvp_level < 5).
- MVP уровень 0–5 даёт множитель урона башни.
- При ручном переходе WAVE → BUILD (пропуск волны) MVP за эту волну не начисляется.
- HUD: топ-5 башен по урону с отображением MVP и подсветкой первой.

### UI и управление
- Индикатор фазы (круг): синий BUILD, жёлтый SELECTION, красный WAVE; клик — следующая фаза.
- Клавиша **Space** — смена фазы (в зависимости от контекста).
- Клавиша **B** — книга рецептов.
- Клавиша **P** — пауза.
- Кнопки скорости времени: 1x, 2x, 4x.
- Здоровье игрока, номер волны, счётчик башен, убийства.
- InfoPanel: при наведении на башню/врага — детали (урон, способности и т.д.).
- Клики по карте обрабатывает InputSystem; клики по UI не передаются в мир (в т.ч. при открытом попапе туториала).

### Дебаг
- Клавиша **I** — вкл/выкл дебаг-метки (координаты гексов при наведении) и панель волны.
- Панель волны: выбор номера волны (0–40) для следующего старта; 0 — идти по счётчику.
- Клавиши **1 / 2 / 3** — тип башни при размещении в обход лимита (атакующая случайная, майнер, стена).
- Клавиша **0** — выключить дебаг-тип башни.
- **Shift+PageUp** — профайлер (если включён).

### Прочее
- Гексагональная карта (осевые координаты q,r), pointy-top.
- Процедурная генерация карты: Entry, Exit, чекпоинты, проходимость, возможность размещения.
- Пул узлов (NodePool) для врагов и снарядов.
- Tutorial: попап победы в туториале блокирует клики по карте (tutorial_complete_popup_visible).
- Справочник врагов и волн: **data/ENEMIES_REFERENCE.md**.
