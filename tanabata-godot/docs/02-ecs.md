# ECS (Entity-Component-System)

## Суть

Всё в игре — сущности (entities) с номерами. Свойства задаются компонентами. Логика живёт в системах, которые перебирают сущности по нужным компонентам.

## Сущности

У каждой сущности есть целочисленный ID. При создании ID растёт. Удаление — автоматическая очистка из всех зарегистрированных хранилищ компонентов (`_component_stores`) и удаление из реестра сущностей. Метод `kill_enemy(entity_id)` — единая точка для убийства врага (инкремент счётчика, XP, destroy).

## Пространственные индексы

- **`ore_hex_index`** (`hex_key → ore_id`) — O(1) поиск руды по гексу. Заполняется при генерации, очищается в `destroy_entity()`.

## Основные компоненты

### Базовые

- **position** — мировые координаты в пикселях.
- **velocity** — скорость движения.
- **health** — текущее и максимальное здоровье (у врагов).

### Визуальные

- **renderable** — цвет, радиус, видимость (для отрисовки).

### Башни

- **tower** — def_id, уровень, гекс, активность, временная/постоянная, выбор, **mvp_level** (0–5, бафф урона).
- **combat** — урон, скорострельность, дальность, перезарядка, тип атаки.
- **turrets** — угол поворота (для будущих турелей).

### Враги

- **enemy** — def_id, броня (физ/маг), **abilities** (массив id способностей), **evasion_chance** (0–1, из волны).
- **path** — список гексов пути и индекс текущей точки.

### Снаряды и эффекты

- **projectile** — источник, цель, урон, скорость, тип урона.
- **laser** — начало, конец, таймер, цвет (для визуала лазера).
- **damage_flash** — таймер вспышки при уроне.

### Руда

- **ore** — мощность, текущий и максимальный запас, гекс.

### Энергосеть

- **energy_line** — ID двух башен, скрыта ли линия.

### Волны

- **wave** — номер волны, враги для спавна, интервал, таймер, путь.

### Игрок

- **player_state** — уровень, опыт, здоровье.

### Специальные (реализованы)

- **slow_effects** — замедление (LASER Silver, NI). timer, slow_factor.
- **poison_effects** — обычный яд. timer, damage_per_sec, tick_timer.
- **jade_poisons** — стакающийся яд (Jade). instances (стаки), damage_per_stack, slow_factor_per_stack.
- **aura_effects** — ауры башен (скорость атаки).
- **beacons**, **beacon_sectors** — Маяк (вращающийся луч).
- **volcano_effects** — Вулкан (огненные круги AoE).

## Состояние игры

Отдельный компонент **game_state** (по сути синглтон):

- фаза (BUILD, WAVE, TOWER_SELECTION);
- номер текущей волны;
- счётчик построенных башен за фазу;
- скорость времени;
- пауза;
- total_enemies_killed;
- debug_tower_type (для режима отладки);
- **tower_damage_this_wave** — накопленный урон по tower_id за текущую волну;
- **last_wave_tower_damage** — список записей {tower_id, name, damage, …} за прошлую волну (для HUD в BUILD);
- **last_wave_number** — номер волны, за которую сохранён last_wave_tower_damage;
- **wave_skipped** — true при переходе WAVE→BUILD вручную (пропуск волны); MVP за такую волну не даётся.
