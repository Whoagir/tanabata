# CombatSystem (система боя)

## Назначение

Управляет атакой башен: поиск целей, создание снарядов или лазеров, учёт энергии.

## Когда работает

Только в фазе WAVE. Только для башен с компонентом combat и is_active = true.

## Поиск целей

Для каждой башни ищутся враги в радиусе (range из combat). Учитываются только живые враги (health > 0). Цели сортируются по расстоянию. Берётся до split_count целей (ближайшие). Радиус считается в гексах через distance_to.

## Энергия

Башня может стрелять, только если есть доступ к энергии. Источники — майнеры на руде в энергосети. Результат поиска источников кэшируется на 0.5 секунды. **Эффективная стоимость выстрела:** для башен с аурой (DE, DA и т.д.) — shot_cost × Config.AURA_ORE_COST_FACTOR; если у башни есть аура скорости (speed_multiplier > 1) — дополнительно × Config.AURA_SPEED_ORE_COST_FACTOR. Для башен под aura_effects стоимость делением на speed_mult не увеличивает расход руды в секунду. Суммарный запас руды должен быть не меньше effective_cost. При выстреле энергия списывается с одной из руд (случайный выбор).

## Типы атак

**PROJECTILE** — создаются сущности снарядов. Урон учитывает: буст от руды в выбранной жиле, множитель от руды в сети (get_network_ore_damage_mult), **MVP** (get_mvp_damage_mult: 1.0 + mvp_level×0.2), бонус от ауры урона. Поддержка split_count, impact_burst (Malachite), JADE_POISON (Jade). Перед нанесением урона в ProjectileSystem/Volcano/Beacon проверяется **roll_evasion** — при успехе урона и эффектов нет (визуал попадания остаётся).

**LASER** — мгновенный урон с учётом MVP и сети; для каждой цели проверка roll_evasion. Создаётся визуальный эффект (линия на Config.LASER_DURATION). Если в attack.params есть slow_multiplier и slow_duration — применяется замедление (Silver).

**NONE / AREA_OF_EFFECT** — пропускаются CombatSystem; Volcano и Lighthouse используют VolcanoSystem и BeaconSystem (там тоже учёт MVP и evasion).

## Cooldown

После выстрела ставится перезарядка: 1 / fire_rate секунд. Башня не стреляет, пока cooldown > 0. Каждый кадр cooldown уменьшается на delta (с учётом aura_effects — множитель скорости атаки).
