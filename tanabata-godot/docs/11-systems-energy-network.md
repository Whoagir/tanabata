# EnergyNetworkSystem (система энергосети)

## Назначение

Связывает башни линиями передачи энергии. Определяет, какие башни активны. Майнеры на руде — корни. Атакующие получают энергию через цепочку соединений.

## Типы башен в сети

- **MINER** — источник энергии, если стоит на руде.
- **ATTACK** — потребитель, стреляет только при доступе к энергии.
- **WALL** — не участвует в сети.

## Правила соединений

- Майнер с майнером — до 4 гексов (ENERGY_TRANSFER_RADIUS), на одной линии (is_on_same_line).
- Соседние башни (расстояние 1 гекс) — любая пара майнер/атакующая/атакующая.
- Атакующая с атакующей — только соседи (1 гекс).
- Стены не участвуют в сети.

## Добавление башни

При постановке башни вызывается add_tower_to_network. Ищутся возможные соединения с уже активными башнями. Майнер на руде — сразу корень, активен. Если соединений нет и не на руде — башня неактивна. Иначе — активна, создаются линии.

## Перехват майнер-майнер

Если новый майнер ставится на линию между двумя майнерами (на одной прямой между ними) — он «перехватывает» линию. Старая линия удаляется, создаются две новые через новый майнер.

## Полная пересборка

При удалении башни сеть пересобирается с нуля. Используется алгоритм MST (минимальное остовное дерево) по приоритетам рёбер. Приоритет: майнер-майнер выше майнер-атакер выше атакер-атакер. Внутри приоритета — по расстоянию.

## Поиск источников питания

Для атакующей башни ищутся все активные майнеры на руде в сети. Возвращается список ID руд (ore entities), с которых можно списывать энергию. Используется CombatSystem для проверки перед выстрелом.

## Пространственные индексы

- **`ore_hex_index`** (в ECSWorld) — O(1) поиск руды по hex_key. Используется в `_is_on_ore()`, `_find_power_sources()`, `get_network_ore_stats()`.
- **`hex_map.get_tower_id(hex)`** — O(1) поиск башни по гексу. Используется в `get_miner_efficiency_for_ore()`, `get_ore_restore_per_round()` вместо перебора всех towers.
- **`line_hex_set`** — предвычисленный Dictionary `hex_key → true` для всех гексов, через которые проходят энерголинии. Пересчитывается при любом изменении сети (`rebuild_energy_network`, `add_tower_to_network`, `handle_tower_removal`, `reconnect_line`). Используется `MovementSystem._apply_environmental_damage()` для O(1) проверки урона от линий.

## Связность сети

`_get_connected_tower_ids(tower_id)` — BFS через adjacency list. Строит `_build_adjacency_list()` один раз и обходит граф за O(V+E) вместо перебора всех energy_lines на каждом шаге.
