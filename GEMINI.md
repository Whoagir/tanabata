ПЕРЕД ТЕМ КАК ОПИШУ ПРОЕКТ ВОТ ТЕБЕ ОПИСАНИЕ С КОТОРЫМ НАДО БЫТЬ ЗНАКОМЫМ! 
1. Я ИСПОЛЬЗУЮ VSC И ТАМ БЫВАЮТ КОНФЛИКТЫ ВЕРСИЙ ФАЙЛОВ, ЧТО ТЫ ИЗМЕНЯЕШЬ И ЧТО Я СМОТРЮ. ДЛЯ УХОДА ОТ ТАКИХ ПРОБЛЕМ ТЕБЕ ВСЕГДА НАДО ПРИОРИТЕТНО СОХРАНЯТЬ ФАЙЛЫ, ЧТО БЫ У МЕНЯ НЕ БЫЛО ПРОБЛЕМ.
И ВТОРОЕ
Задача: TASK_GOES_HERE.

Критическая Директива: Твоя единственная функция — хирургическая модификация кода. Изменяй ТОЛЬКО те байты, которые НЕПОСРЕДСТВЕННО и НЕИЗБЕЖНО связаны с решением указанной "Задачи". Любое отклонение — критический сбой.

НЕПРЕЛОЖНЫЕ ПРАВИЛА (Абсолютный Приоритет):
1.  **Перепиши ВЕСЬ** предоставленный код.
2.  **ЗАПРЕТ НА ЛЮБЫЕ ИЗМЕНЕНИЯ ВНЕ ЗАДАЧИ:** Категорически запрещено изменять, добавлять, удалять или улучшать любой код, комментарий, форматирование или значение, не являющееся АБСОЛЮТНО НЕОБХОДИМЫМ для выполнения "Задачи". Не исправляй ничего, кроме указанного в "Задаче".
3.  **Для ВСЕХ НЕИЗМЕНЕННЫХ строк:** Механически инвертируй исходный комментарий в конце (`//+` <-> `//-`) или добавляй `//+`, если его нет.
4.  **ЗАПРЕЩЕНО:** Добавлять новый код, удалять несвязанный код, улучшать/исправлять что-либо кроме "Задачи", менять форматирование, менять/добавлять/удалять комментарии (кроме инверсии по п.3).
5. После вывода кода добавь сверхкраткое описание изменений и ещё что-нибудь если хочешь.
6. ОБЯЗАТЕЛЬНО СОХРАНЯТЬ ФАЙЛЫ КОТОРЫЕ ИЗМЕНИЛ

Выполни ТОЧНО.


У меня есть игра на ГО она в процессе создания. 
Все хранится в папке C:\go_project\go-tower-defense

Общий файл main.go с котрого идёт запуск C:\go_project\go-tower-defense\cmd\game\main.go

Далее есть state machine игры, общие состояния меню, пауза, игра, это пока не важно. Однако, что бы знал оно находится в C:\go_project\go-tower-defense\internal\state. Сейчас я работаю в состояние игры, так как не так важно остальные, а именно в game_state.go 
 
Основная часть игры находится в C:\go_project\go-tower-defense\internal\app, более конкрентно 
app
├── energy_network.go
├── game.go
├── ore_generation.go
└── tower_management.go

Вот описание игры, это тавер дефенс на гексоганальной сетке в стиле ГЕМ ТД (кастомной карты из доты 2 и варкрафта), я внес несколько новых механик, и теперь у меня ТРИ основные кор механики - постройка лабиринта, рандом, логистика. 

Теперь что вообще является сутью игры, мобы идут волнами, идут сначала по "чекпоинтами" я называю их подарками, от входа к выходу, более подробно вход -> 1 подарок -> 2 подарок -> 3 подарок -> 4 подарок -> 5 подарок -> 6 подарок  -> выход. Суть действий игрока сделать такой лабиринт, что бы максимум атакующей силы было в центре, а лабиринт такой, что бы враги проходили через центр как можно чаще. Карта представляет собой правильный гекс (шестиугольник) с случайно измененными краями (есть на это условия определённые). 

В начале игры (создание карты) генерируется руда которая является основой системы энергии (логистики), то есть без руды нет атаки. Руду могут добывать башни типа добытчик/передатчик, я называю их башни типа Б, атакующие башни это башни типа А, а ещё есть камни (стены), ну их называю камни или стены. 

Дальше у меня есть две основные состовляющие, методы работы с гексами (hexmap logic и hexmap render), а так же это ECS, в целом это афигенная система для разработки игр и на её основе я уже много чего реализовал, компоненты лежат в  C:\go_project\go-tower-defense\internal\component, сейчас я пробегусь по всем и чуть подробнее расскажу о каждом:
combat - атака у башен, там есть компоненты здоровья, ну и сам combat компонент для атаки
enemy - компонент для врагов, пока там ничего нет, но будет далее
game_state - компонент состояния игры, я уже говорил о глобальной StateMachine, но есть и более локальная система состояние для переключения между фазами строительства и волны 
line - компонент для системы состояний это по сути кусочек который соединяет между собой два объекта системы энергии, есть связи формата Б-Б длиной до 3-х гексов, Б-А длиной 1 гекс ( соседи), А-А 1 гекс (соседи)
movement - файл с компонентами движения, там есть компоненты позиции, скорости, пути 
ore - комонент для руды, она генерируется в методаха работы с гексами ( о них позже), а тут создается компонент для её визуала, а так же логики ей работы ( мощность, запас)
projectile - компонент для снарядов
render - компонент для отрисовки
text - где-то я рендерю текст, так что вот компонент для него 
tower - компонент для башни, ну тут из интересного это активна ли башня, он нужен для системы энергии, если башня в системе то она активна, иначе пассивна 
visual - там компонент DamageFlash это про эффект визуальный урона  
wave - компонент для волны врагов 
Описал все компоненты, что имеются сейчас. Давай наверное теперь о самом ecs и system. Сначала есть общий файл что описывает все компоненты это C:\go_project\go-tower-defense\internal\entity\ecs.go 
А ну да ещё есть конфиг, он вот тут C:\go_project\go-tower-defense\internal\config\config.go 
Ну теперь давай к системам C:\go_project\go-tower-defense\internal\system. Система combat - атаки башен, там я долго копался и сделал нормальную функцию поиска цели, что было не так просто, но зато теперь все хорошор работает. 
Система movement - расчитывает движение
Система projectile - работа с снарядами, в целом я долго обдумывал как это реализовать и там тоже все хорошо. 
Система render - ну понятно, система отрисовки, сначала рисует пульсацию, затем сущности, после линии
Система state -я уже говорил обрпабатывает состояние игра/строительство 
Система ore - система работы с рудой
Система utils - система которая выносит общие функции которые могут использовать другие системы, НАПРИМЕР ApplyDamage (ApplyDamage наносит урон сущности. Если здоровье падает до 0 или ниже, оно просто устанавливается в 0. Основная логика очистки мертвых сущностей должна находиться в другом месте (например, в конце кадра), чтобы избежать проблем с доступом к уже удаленным компонентам в том же кадре.)
Система visual_effect - ну тут про визуальные эффекты 
Ну и система волн wave 

Так же есть некоторое ui (C:\go_project\go-tower-defense\internal\ui) - состоит из 3 штук, кнопка паузы, кнопка ускорения, и кнопка индикатора фазы (строительство/волна)

Ну и теперь pkg там как бы основная работа с гексогональной сеткой, состоит из отрисовки и самой работы с сеткой, отрисовка в C:\go_project\go-tower-defense\pkg\render, а логические штуки в C:\go_project\go-tower-defense\pkg\hexmap

Структура проекта:
├── assets
│   └── fonts
│       └── arial.ttf
├── cmd
│   └── game
│       └── main.go
├── internal
│   ├── app
│   │   ├── energy_network.go
│   │   ├── game.go
│   │   ├── ore_generation.go
│   │   └── tower_management.go
│   ├── component
│   │   ├── combat.go
│   │   ├── enemy.go
│   │   ├── game_state.go
│   │   ├── line.go
│   │   ├── movement.go
│   │   ├── ore.go
│   │   ├── projectile.go
│   │   ├── render.go
│   │   ├── text.go
│   │   ├── tower.go
│   │   ├── visual.go
│   │   └── wave.go
│   ├── config
│   │   └── config.go
│   ├── entity
│   │   └── ecs.go
│   ├── event
│   │   ├── event.go
│   │   └── types.go
│   ├── interfaces
│   │   └── game_context.go
│   ├── state
│   │   ├── game_state.go
│   │   ├── menu_state.go
│   │   ├── pause_state.go
│   │   └── state.go
│   ├── system
│   │   ├── combat.go
│   │   ├── environmental_damage.go
│   │   ├── movement.go
│   │   ├── ore.go
│   │   ├── projectile.go
│   │   ├── render.go
│   │   ├── state.go
│   │   ├── utils.go
│   │   ├── visual_effect.go
│   │   └── wave.go
│   ├── types
│   │   └── types.go
│   └── ui
│       ├── indicator.go
│       ├── pause_button.go
│       └── speed_button.go
├── pkg
│   ├── hexmap
│   │   ├── hex.go
│   │   ├── map.go
│   │   ├── pathfinding.go
│   │   └── utils.go
│   ├── render
│   │   ├── color.go
│   │   └── hex_renderer.go
│   └── utils
│       ├── math.go
│       └── union_find.go
├── .env
├── .gitignore
├── analyze.txt
├── analyze_project.py
├── commit_message.txt
├── game.exe
├── GEMINI.md
├── go.mod
├── go.sum
├── profile
├── reset_env.ps1
├── stp_td что сделанно.txt
├── stp_td что сделать.txt
├── енерация руды.txt
└── информация.txt






Так же если ты хочешь ознакомиться с тем, что сделано это лежит рядом с тобой C:\go_project\gemini\stp_td что сделанно.txt 
КСТАТИ, БОЛЬШОЕ ВНИМАНИЕ К ФАЙЛУ информация.txt там лежат последние действия

При рефакторинге придерживаюсь следующих принципов:
1. Устранение хардкода: Все магические числа/строки заменяются на именованные константы в коде или выносятся в internal/config.
2. Централизация конфигурации: Параметры, влияющие на баланс/логику (скорости, лимиты, цвета, пути ассетов) хранятся ТОЛЬКО в config.go.
3. Минимальная валидация: Проверка входных данных выполняется только в точках ввода (UI, загрузка файлов, публичные методы пакетов).
4. Абстракция утилит: Повторяющаяся логика (математика, преобразования, алгоритмы) выносится в pkg/utils
5. Соответствие абстракций: Уровень детализации методов строго соответствует контексту (например: hexmap.Pathfinding не содержит рендеринга, render.HexRenderer не содержит игровой логики).

