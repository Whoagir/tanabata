# Дизайн-документ: Tower Defense Project

## 1. Концепция игры

**Жанр:** 3D Tower Defense с элементами головоломки и экономической стратегии.

**Краткое описание:** 
Это игра в жанре Tower Defense, вдохновленная классическими картами в стиле "Gem TD". Игроку предстоит строить оборонительные лабиринты из башен на гексагональной карте, чтобы остановить волны врагов. Ключевой особенностью является гибрид трех механик: стратегическое построение лабиринта, управление ресурсами через логистическую энергосеть и элемент случайности в получении и улучшении башен через систему крафта.

**Уникальные особенности:**
*   **Трехмерная гексагональная карта:** Истинное 3D-пространство с возможностью вращения и приближения камеры.
*   **Динамический лабиринт:** Враги движутся по чекпоинтам, и задача игрока — не просто строить башни, а формировать максимально длинный и эффективный путь для них.
*   **Энергетическая логистика:** Башни не атакуют "бесплатно". Они потребляют энергию, которая добывается из рудных жил и распределяется по сети, которую строит сам игрок. Это добавляет экономический и логистический слой в геймплей.
*   **Глубокая система крафта:** Новые, более мощные башни не просто покупаются, а создаются путем комбинирования трех существующих башен по определенным рецептам.

**Целевая аудитория:**
*   **Основная:** Опытные игроки в жанре Tower Defense и стратегических головоломок (20-40 лет), которые ценят глубокий геймплей, требующий планирования, оптимизации и долгосрочной стратегии. Им интересны сложные механики, такие как построение лабиринтов и управление ресурсами.
*   **Вторичная:** Более широкая аудитория любителей тактических игр, в том числе на мобильных платформах, которых можно привлечь уникальным сочетанием знакомого TD-геймплея с инновационными механиками крафта и логистики.

## 2. Игровой цикл

Игровой процесс четко разделен на три повторяющиеся фазы, каждая из которых требует от игрока разных действий и стратегических решений.

### Фаза 1: Строительство (Build State)
*   **Цель:** Построить или улучшить лабиринт и оборонительные позиции.
*   **Действия игрока:**
    *   **Размещение временных башен:** Игроку на свободные ячейки случайным образом выпадают 5 башен базового уровня. Эти башни являются "черновиками".
    *   **Управление лабиринтом:** Размещая башни, игрок изменяет путь, по которому будут двигаться враги.
*   **Завершение:** Фаза завершается, когда игрок готов к выбору.

### Фаза 2: Выбор башен (Tower Selection State)
*   **Цель:** Выбрать, какие из построенных временных башен останутся на карте, возможно, улучшив или изменив их.
*   **Действия игрока:**
    *   **Выбор для сохранения:** Из пяти временных башен игрок должен совершить ровно **два действия по сохранению**. Остальные три башни превращаются в стены. Подробнее см. в разделе "Получение и улучшение башен".
*   **Завершение:** Фаза завершается автоматически после двух действий по сохранению.

### Фаза 3: Волна (Wave State)
*   **Цель:** Уничтожить волну наступающих врагов.
*   **Процесс:**
    *   **Спавн врагов:** Враги начинают появляться у "Входа" и двигаться по пути к "Выходу".
    *   **Атака башен:** Постоянные башни атакуют врагов.
    *   **Крафт по рецептам:** **Только в эту фазу** игрок может объединять три РАЗНЫЕ башни в одну новую, более мощную, согласно книге рецептов.
*   **Завершение:** Фаза завершается, когда все враги уничтожены. Цикл возвращается к Фазе 1.

## 3. Ключевые механики

### 3.1. Построение лабиринта и путь врагов
Суть обороны заключается не только в огневой мощи, но и в контроле пути врагов.
*   **Путь через чекпоинты:** Враги не идут напрямую от входа к выходу. Их маршрут состоит из сегментов: Вход -> Чекпоинт 1 -> Чекпоинт 2 -> ... -> Выход.
*   **Динамический A*:** Путь постоянно пересчитывается с помощью алгоритма A*, где все башни и стены являются непроходимыми препятствиями.
*   **Стратегическая цель:** Игрок должен строить лабиринт таким образом, чтобы:
    1.  Максимально удлинить путь врагов.
    2.  Создать "зоны убийства" (kill zones), где враги будут проходить несколько раз мимо одних и тех же мощных башен.

### 3.2. Энергетическая сеть и логистика руды
Башни не работают без энергии, что создает дополнительный стратегический слой.
*   **Типы башен:**
    *   **Тип А (Атакующие):** Наносят урон, накладывают эффекты. Потребляют энергию.
    *   **Тип Б (Добывающие/Передающие):** Добывают энергию из рудных жил и передают ее по сети.
    *   **Тип Д (Стены/Камни):** Препятствия, формирующие лабиринт.
*   **Рудные жилы:** На карте генерируются три жилы руды (центральная, средняя, крайняя), которые являются источником энергии.
*   **Построение сети:** Игрок должен строить непрерывную цепь из башен типа Б от рудной жилы к башням типа А. Связи имеют ограничения по дальности.
*   **Деградация сигнала:** Чем дальше башня типа А находится от источника (башни Б на руде), тем слабее "сигнал" и, возможно, ниже ее эффективность (например, урон).
*   **Бонус бедной руды:** Механика, поощряющая использование истощающихся рудных жил. Если башня типа А совершает выстрел, используя энергию от жилы, в которой осталось мало руды (менее 75 единиц), она получает бонус к урону. Чем меньше руды в жиле (вплоть до порога в 15 единиц), тем выше бонус. Это мотивирует игрока не "застаивать" энергию, а активно использовать все доступные источники.

### 3.3. Получение и улучшение башен
Это многоуровневая система, сочетающая случайность, риск и стратегию.

#### **Шаг 1: Рандомизированное получение (Фаза строительства)**
В начале каждого раунда игрок получает 5 случайных временных башен 1-го уровня. Вероятность выпадения разных башен определяется специальной таблицей лута (`loot_tables.json`).

#### **Шаг 2: Улучшение, Даунгрейд и Сохранение (Фаза выбора)**
Во время этой фазы игрок должен выполнить **два действия сохранения**. Каждое действие может быть одним из следующих:
*   **Простое сохранение:** Выбрать одну временную башню. Она становится постоянной.
*   **Улучшение (Upgrade):** Если на поле есть несколько одинаковых временных башен, их можно объединить в одну, более мощную. Это действие сразу сохраняет полученную башню.
    *   **Правило "2 в 1":** Две одинаковые башни (напр., 2x `TA` ур. 1) -> одна башня того же типа уровнем выше (1x `TA` ур. 2).
    *   **Правило "4 в 1":** Четыре одинаковые башни (напр., 4x `TA` ур. 1) -> одна башня того же типа на **два** уровня выше (1x `TA` ур. 3).
*   **Даунгрейд (Downgrade):** Игрок может выбрать одну временную башню и понизить ее уровень. Это рискованное действие, которое также считается сохранением.
    *   **Правило:** Башня (напр., `TA` ур. 4) превращается в **СЛУЧАЙНУЮ** башню на один уровень ниже (т.е. любую башню 3-го уровня, например `TE` ур. 3 или `PO` ур. 3). Это позволяет с некоторым риском сменить тип башни, если текущий не подходит.

#### **Шаг 3: Крафт по рецептам (Фаза волны)**
Это основной способ получения мощных, уникальных башен.
*   **Правило:** Во время волны игрок может выбрать три **разные** постоянные башни на поле. Если их комбинация соответствует одному из рецептов в `recipes.json`, они объединяются в одну новую, мощную башню (например, `TA` + `PA` + `NI` -> `TOWER_SILVER`).
*   **Книга рецептов:** В интерфейсе есть книга, где игрок может посмотреть все известные ему рецепты.

## 4. Игровые сущности

### 4.1. Башни
Все башни делятся на несколько категорий: базовые, создаваемые по рецептам и служебные.

#### **Базовые башни (Уровень крафта 0)**
Это "строительные блоки", которые игрок получает в начале раунда.
*   **Прямой урон:**
    *   `TA` (Физ. атака): Стандартная башня с физическим уроном.
    *   `TE` (Маг. атака): Стандартная башня с магическим уроном.
    *   `TO` (Чист. атака): Наносит чистый урон, игнорирующий броню.
*   **Сплит-атака (поражает несколько целей):**
    *   `PA` (Сплит-физ.): Снаряд разделяется на 2, нанося физический урон.
    *   `PE` (Сплит-маг.): Снаряд разделяется на 2, нанося магический урон.
    *   `PO` (Сплит-чист.): Снаряд разделяется на 2, нанося чистый урон.
*   **Поддержка и эффекты:**
    *   `DE` (Аура): Увеличивает скорость атаки соседних башен.
    *   `NI` (Замедление): Атакует врагов, замедляя их скорость передвижения.
    *   `NU` (Яд): Атакует врагов, накладывая эффект постепенного урона.

#### **Создаваемые башни (Уровень крафта 1+)**
Это мощные башни, получаемые только через крафт по рецептам.
*   `TOWER_SILVER` (Сильвер): Стреляет мощным **лазером** с физическим уроном.
*   `TOWER_MALACHITE` (Малахит): Выпускает магический снаряд, который при попадании **разделяется на 3** и дополнительно взрывается, нанося урон по области.
*   `TOWER_VOLCANO` (Вулкан): Наносит периодический **урон по области** вокруг себя.
*   `TOWER_LIGHTHOUSE` (Маяк): Атакует вращающимся **лучом чистого урона** в определенном секторе.
*   `TOWER_JADE` (Нефрит): Накладывает на врагов особый, мощный **магический яд**.

#### **Служебные башни**
*   `TOWER_MINER` (Шахтер): Башня типа Б. Размещается на руде для добычи энергии и может передавать ее на расстояние до 3 гексов.
*   `TOWER_WALL` (Стена): Башня типа Д. Непроходимое препятствие, формирующее лабиринт. Получается из "лишних" башен в фазе выбора.

### 4.2. Враги
Враги обладают разным уровнем здоровья, скорости и, что самое важное, разным уровнем физической и магической брони.
*   **Стандартные:**
    *   `ENEMY_NORMAL_WEAK` (Слабый): Мало здоровья и брони.
    *   `ENEMY_NORMAL` (Обычный): Сбалансированные характеристики.
    *   `ENEMY_TOUGH` (Крепкий): Много здоровья и брони.
*   **Специализированные:**
    *   `ENEMY_MAGIC_RESIST` (Магический щит): Очень высокая магическая броня, но **отрицательная** физическая (уязвим к физ. атакам).
    *   `ENEMY_PHYSICAL_RESIST` (Физический щит): Очень высокая физическая броня, но **отрицательная** магическая (уязвим к маг. атакам).
    *   `ENEMY_FAST` (Быстрый): Среднее здоровье, но очень высокая скорость передвижения.
*   **Элитный:**
    *   `ENEMY_BOSS` (Босс): Огромный запас здоровья, высокая скорость и мощная броня обоих типов. Появляется на определенных волнах.

## 5. Пользовательский интерфейс (UI) и Управление

### 5.1. Философия дизайна
Интерфейс стремится к минимализму и интуитивности. Вся необходимая информация подается через визуальные иконки и шкалы, избегая перегрузки экрана цифрами. Цель — позволить игроку сосредоточиться на игровом поле, а не на интерфейсе.

### 5.2. Основной игровой экран (HUD)
*   **Вверху слева:**
    *   **Здоровье игрока:** Визуальная шкала (например, в виде сердца или щита), которая постепенно "трескается" или пустеет.
    *   **Уровень и опыт игрока:** Круговая шкала вокруг иконки уровня.
*   **Вверху справа:**
    *   **Номер волны:** Простая иконка врага с числом рядом.
*   **Внизу справа:**
    *   **Индикатор фазы:** Иконка молотка (Строительство) сменяется на иконку скрещенных мечей (Волна).
    *   **Управление временем:** Кнопки "Пауза" (||) и "Ускорение" (>>).
    *   **Индикатор режима "U":** Иконка, сигнализирующая об активном режиме перетаскивания линий.
*   **Внизу слева:**
    *   **Индикаторы рудных жил:** Три цветные шкалы, показывающие состояние каждой жилы.

### 5.3. Взаимодействие с объектами

#### **Информационная панель**
При выборе башни или врага появляется **небольшая, контекстная панель** рядом с объектом.
*   **Содержимое:**
    *   Иконка типа (атака, поддержка, добыча).
    *   Шкалы, визуально отображающие ключевые параметры: Урон, Скорость атаки, Радиус.
    *   Для врагов: шкалы физ. и маг. брони.
*   **Взаимодействие:** На панели нет кнопок. Все действия (крафт, выбор) производятся напрямую на игровом поле через горячие клавиши.

#### **Книга рецептов**
*   **Реализация:** Вызываемое по кнопке окно.
*   **Дизайн:** Рецепты представлены в виде "Иконка + Иконка + Иконка = Иконка результата", без лишнего текста. Добавлена возможность фильтрации по имеющимся компонентам.

### 5.4. Управление
Управление построено на интуитивном взаимодействии с мышью и использовании клавиатуры для продвинутых функций и контроля камеры.

#### **Мышь**
*   `ЛКМ`: Основное взаимодействие — выбор объекта, размещение башни, подтверждение действия.
*   `ПКМ`: Отмена выбора/действия.
*   `Колесо мыши`: Приближение/отдаление камеры (альтернатива клавишам R/T).
*   `Зажатое СКМ (Средняя кнопка мыши)`: Вращение камеры вокруг центральной точки.

#### **Клавиатура: Основные действия**
*   `Shift + ЛКМ/ПКМ`: **Ключевая механика.** Добавление/удаление башни из группы ручного выбора для последующего крафта или сохранения.
*   `U`: Включение/выключение режима ручного перетаскивания энергетических линий.
*   `B`: Открыть/закрыть Книгу рецептов.
*   `F9`: Пауза/возобновление игры.

#### **Клавиатура: Управление камерой**
*   `R`: Приблизить камеру (уменьшить FoV).
*   `T`: Отдалить камерку (увеличить FoV).
*   `Y`: Сбросить приближение/отдаление к значению по умолчанию.
*   `P`: Переключить тип проекции камеры между "Перспективой" и "Ортографией".

#### **Клавиатура: Отладка**
*   `F3`: Включить/выключить режим визуальной отладки.
*   `F10`: Включить/выключить "Режим Бога".
*   `1, 2, 3, 0`: Создание предопределенных башен в режиме отладки.

## 6. Арт-дирекшн и Визуальный Дизайн

### 6.1. Ключевая концепция: "Прагматичный Гекстек" (Grounded Hex-Tech)
Это не классический стимпанк с избытком шестеренок. Это мир на пороге индустриальной революции, где магия (руда) стала топливом для первых паровых и электрических механизмов. Эстетика вдохновлена сериалом **"Аркейн"** (дуализм технологий Пилтовера и Зауна) и приземленностью **"Игры Престолов"**. Технологии здесь не изящны — они массивны, функциональны, брутальны и немного опасны.

**Атмосфера:** Сочетание тактической ясности **Kingdom Rush** с мрачной, меланхоличной атмосферой **Kingdom Two Crowns**. Игрок должен чувствовать себя инженером-стратегом на последнем рубеже обороны.

### 6.2. Окружение и Карта
*   **Стиль:** Low-poly минимализм. Детализация достигается за счет качественных текстур, освещения и сильных силуэтов, а не за счет большого количества полигонов.
*   **Гексы:** Это не плоские плитки, а объемные "колонны" из земли и камня разной высоты. Это создает ощущение рельефа и тактической глубины.
*   **Материалы:** Преобладают натуральные, грубые материалы: **темный, необработанный камень, старое дерево, кованое железо, тусклая медь и бронза**.
*   **Края карты:** Карта не обрывается резко. Она окружена неприступными скалами, густым туманом или темной водой, создавая ощущение изолированного "острова" или бастиона.
*   **Порталы (Вход/Выход):** Массивные каменные арки, увитые медными трубами и светящимися рунами. Входной портал нестабильно мерцает темной энергией, выходной — светится угрожающим красным.
*   **Освещение и атмосфера:** Мягкое, рассеянное освещение. Легкий туман стелется по низинам. Частицы пыли или пепла витают в воздухе. Акцентное освещение исходит только от руды, энергосети и эффектов.

### 6.3. Дизайн фракций

#### **Игрок (Инженеры / Защитники) - Язык форм: Квадрат и Брутализм**
Технологии игрока основаны на стабильности, защите, порядке и грубой силе. Никаких хлипких или изящных конструкций.
*   **Общий дизайн:** Массивные, "тяжелые" конструкции. Основания башен — грубо отесанные каменные блоки. Механизмы сделаны из клепаного железа и меди.
*   **Башни-добытчики (Тип Б):** Механизм добычи скрыт. На поверхности видна массивная, медленно вращающаяся **шестерня** или система из нескольких шестерен, утопленная в каменное основание. При работе из-под нее идет густой пар.
*   **Атакующие башни (Тип А):**
    *   **Физические:** Похожи на миниатюрные баллисты или мортиры с паровым приводом.
    *   **Магические/Энергетические:** Каменные постаменты, на которых установлены медные катушки и фокусирующие кристаллы, потрескивающие энергией.
    *   **Улучшения:** Улучшенные версии становятся визуально больше, массивнее, обрастают дополнительными трубами, резервуарами или более крупными кристаллами. Платформа башни может становиться шире.
*   **Стены (Тип Д):** Не просто гексы. Это отдельные, грубо сложенные каменные блоки с металлическими скобами, как в древних крепостях.

#### **Враги (Автоматоны / Големы) - Язык форм: Треугольник**
Враги — это бездушные механизмы, созданные для прорыва. Их дизайн агрессивен и нестабилен.
*   **Общий дизайн:** Острые углы, асимметрия, грубая сборка.
*   **Материалы:** Ржавое железо, тусклая латунь, сколотый камень, скрепленный скобами. Единственный яркий элемент — одинокий, светящийся "глаз" или ядро.
*   **Типы врагов:**
    *   **Стандартный:** Неуклюжий механизм на двух-трех ногах, с примитивным корпусом.
    *   **Быстрый:** Более легкая конструкция, возможно, на колесе или паучьих ногах.
    *   **Крепкий:** Массивный, похожий на шагающий таран, покрытый дополнительными пластинами брони.
    *   **С щитом:** Несет перед собой большой энергетический или физический щит, который визуально трескается и разрушается по мере получения урона.
*   **Визуализация урона:** Ключевая особенность. По мере потери здоровья у врагов **отваливаются куски брони, появляются вмятины, начинает искрить проводка**. Это основной способ оценки здоровья врага, заменяющий традиционный health bar.

### 6.4. Ключевые визуальные элементы и VFX
*   **Руда:** Гексы с рудой **расположены на уровень ниже** основного ландшафта, образуя "карьеры". Сама руда — это **жилы** магического минерала, прорастающие в стенах этих углублений. Они ярко пульсируют мягким, внутренним светом. По мере истощения свет тускнеет, а кристаллы осыпаются.
*   **Энергосеть:** Это **главный визуальный элемент на карте**.
    *   **Реализация:** Линии энергии идут **по земле и внутри стен**. Это не провода, а **светящиеся рунические каналы**, вырезанные прямо в камне.
    *   **Передача энергии:** При каждом выстреле башни по каналу пробегает яркий импульс света.
    *   **Урон врагам:** Когда враг наступает на активный канал, его бьет разрядом энергии от земли.
*   **Снаряды и эффекты:** Яркие, четкие и понятные (в стиле **Kingdom Rush**).
    *   **Физические:** Летящие болты, раскаленные ядра.
    *   **Магические:** Нестабильные сгустки чистой энергии.
    *   **Яд/Замедление:** Вязкие капли или ледяные осколки.
    *   **Взрывы:** Короткие, сочные вспышки с разлетающимися частицами.
*   **Чекпоинты (Древние Рунные Резонаторы):** Это не просто алтари, а вершины древних технологий, уходящих глубоко под землю. Их цель — **накопить энергию для открытия финального портала**. Враги-автоматоны подключаются к ним, чтобы передать собранную энергию.
    *   **Визуально:** Массивный каменный постамент, из которого выступают медные контакты и тускло светящийся кристалл. При активации врагом, кристалл вспыхивает ярче, а по земле вокруг расходятся рунические цепи, соединяясь со следующим резонатором.

## 7. Визуальные концепты (Блиц-шторм)

### 7.1. Башни (Одобренные концепты)
*   **`TA` (Физ. атака):**
    *   1. Арбалетная турель
    *   2. Паровая пушка
    *   3. Гарпунная установка
    *   4. Шипомет
*   **`TE` (Маг. атака):**
    *   6. Кристаллический фокусер
    *   9. Рунический камень
*   **`NI` (Замедление):**
    *   11. Ледяная пушка (общая идея)
    *   15. Акустический замедлитель
*   **`PA` (Сплит-физ.):**
    *   16. Двойной арбалет
    *   17. Дробовик
    *   19. Вентилятор с лезвиями
    *   20. Цепная пушка
*   **`NU` (Яд):**
    *   22. Споровая мортира
    *   23. Чумной коготь
    *   25. Жало
*   **`DE` (Аура):**
    *   27. Знамя войны
    *   30. Инжектор адреналина
*   **`PE` (Сплит-маг.):**
    *   34. Рикошетный луч
    *   Новая идея: Башня, выпускающая два магических снаряда одновременно.
*   **`TOWER_VOLCANO` (Вулкан):**
    *   36. Паровая турбина
    *   38. Дрожь земли

### 7.2. Враги (Одобренные концепты)
*   **`ENEMY_NORMAL` (Обычный):**
    *   41. Ходун (двуногий механизм)
    *   42. Треножник
    *   43. Катящийся булыжник
    *   45. Заводной голем
*   **`ENEMY_FAST` (Быстрый):**
    *   48. Меха-паук
*   **`ENEMY_TOUGH` (Крепкий):**
    *   51. Шагающая крепость
    *   52. Таран на гусеницах
*   **`ENEMY_MAGIC_RESIST` (Маг. щит):**
    *   57. Поглотитель (несет "сачок")
    *   58. Заземленный (сбрасывает разряды)
    *   59. Рунический страж
